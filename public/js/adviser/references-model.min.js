!function(e,t){"use strict";function r(e,t){for(var r in t)e[r]=t[r];return e}function s(r,s){this._events={},this._refs={},this.clearAll=!1,this._update=0,this._storeName=r,s&&"/"!==s.slice(-1)[0]&&(s=s+="/"),this._url=s;var i=this._namespace=".cab-references."+(""+Math.random()).slice(-1);t(e).on("storage"+i,this._onStorage.bind(this)).on("load pageshow focus".split(" ").join(i+" ")+i,this._load.bind(this,!1)),this._load()}var i={get:function(e){return e=this.getKey(e),this.clearAll?void 0:this._refs[e]},add:function(e){(this.clearAll||0===this.count)&&(this._refs={},this.clearAll=!1);var t=this.getKey(e);e=this._refs[t]=r({date:Date.now(),key:t},e),this._save("add",e)},remove:function(e){var t=this.getKey(e);e=this._refs[t],delete this._refs[t],this._save("remove",e)},clear:function(){this.count()&&(this.clearAll=!0,this._save("clear"))},undoClear:function(){this.clearAll&&(this.clearAll=!1,this._save("undoClear"))},destroy:function(){localStorage.removeItem(this._storeName),t(e).off(this._namespace),this._events=null},count:function(){var e,t=0;if(this.clearAll)return 0;for(e in this._refs)++t;return t},toArray:function(){var e,t,s=[];if(!this.clearAll)for(e in this._refs)t=this._refs[e],this._refs.hasOwnProperty(e)&&s.push(r({},t));return s},on:function(e,t){var r=this._events;(r[e]=r[e]||[]).push(t)},emit:function(e){var t=this._events[e];if(t){var r=[].slice.call(arguments,1);t.forEach(function(e){e.apply(this,r)},this)}},getKey:function(e){if(null==e)throw new TypeError("No reference supplied");return"string"==typeof e?e:e.id+":"+(e.hash||"")},_save:function(e,t){var r=this,s=JSON.parse(localStorage.getItem(r._storeName))||{};this._update=((s.update||0)+1)%9007199254740991,localStorage.setItem(r._storeName,JSON.stringify({refs:r._refs,clearAll:r.clearAll,update:r._update,lastOwner:r.lastOwner})),this.emit(e,t),this.emit("change")},_load:function(){var e=JSON.parse(localStorage.getItem(this._storeName))||{};this._update!==e.update&&(this.lastOwner=e.lastOwner||"",this._update=e.update||0,this._refs=e.refs||{},this.clearAll=e.clearAll||!1,this.emit("load"),this.emit("change"))},_onStorage:function(e){var t=e.originalEvent.key;t===this._storeName&&this._load()},serverSave:function(e){if(this.lastOwner=e,this._save("owner"),!this._url)throw new Error("serviceUrl has not been configured");return t.ajax(this.count()?{url:this._url+encodeURI(e),type:"PUT",contentType:"application/json; charset=UTF-8",data:JSON.stringify(this.toArray())}:{url:this._url+encodeURI(e),type:"DELETE"})},serverLoad:function(e){if(!this._url)throw new Error("serviceUrl has not been configured");return t.ajax({url:this._url+encodeURI(e),dataType:"text"}).then(function(e,t,r){return{refs:JSON.parse(e),date:new Date(r.getResponseHeader("last-modified"))}},function(e){return 404===e.status?t.Deferred().resolve(null):t.Deferred().reject(e)})},replace:function(e){var t={};return e.forEach(function(e){var s=this.getKey(e),i=r({},e);i.key=s,i.url=(i.url||"").replace(/^(([^:\/?#]+):)(\/\/([^\/?#]*))/,""),t[s]=i},this),this.clearAll=!1,this._refs=t,this._save("replace")}};for(var a in i)s.prototype[a]=i[a];var n="cab_refs";if(e.localStorage){var o=e.CAB=e.CAB||{},l=new s(n,o.referenceServiceUrl);o.references=l}}(window,jQuery);
//# sourceMappingURL=references-model.min.js.map